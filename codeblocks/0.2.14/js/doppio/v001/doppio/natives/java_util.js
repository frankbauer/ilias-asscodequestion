"use strict";function OpenItem(a,b){var c=NextId++;return b[c]=a,c}function GetItem(a,b,c,d){var e=c[b];return e?e:(a.throwNewException("Ljava/lang/IllegalStateException;",d),null)}function CloseItem(a,b){delete b[a]}function OpenZipFile(a){return OpenItem(a,ZipFiles)}function CloseZipFile(a){CloseItem(a,ZipFiles)}function GetZipFile(a,b){return GetItem(a,b,ZipFiles,"ZipFile not found.")}function OpenZipEntry(a){return OpenItem(a,ZipEntries)}function CloseZipEntry(a){CloseItem(a,ZipEntries)}function GetZipEntry(a,b){return GetItem(a,b,ZipEntries,"Invalid ZipEntry.")}function OpenZStream(a){return OpenItem(a,ZStreams)}function CloseZStream(a){CloseItem(a,ZStreams)}function GetZStream(a,b){return GetItem(a,b,ZStreams,"Inflater not found.")}var DoppioJVM=require("../doppiojvm"),util=DoppioJVM.VM.Util,Long=DoppioJVM.VM.Long,AbstractClasspathJar=DoppioJVM.VM.ClassFile.AbstractClasspathJar,BrowserFS=require("browserfs"),path=require("path"),fs=require("fs"),ThreadStatus=DoppioJVM.VM.Enums.ThreadStatus,deflate=require("pako/lib/zlib/deflate"),inflate=require("pako/lib/zlib/inflate"),crc32=require("pako/lib/zlib/crc32"),adler32=require("pako/lib/zlib/adler32"),ZStreamCons=require("pako/lib/zlib/zstream"),i82u8=util.i82u8,isInt8Array=util.isInt8Array,buff2i8=util.buff2i8,BFSUtils=BrowserFS.BFSRequire("bfs_utils"),MAX_WBITS=15,CanUseCopyFastPath=!1;if("undefined"!=typeof Int8Array){var i8arr=new Int8Array(1),b=new Buffer(i8arr.buffer);i8arr[0]=100,CanUseCopyFastPath=i8arr[0]==b.readInt8(0)}var ZipFiles={},ZipEntries={},ZStreams={},NextId=1,java_util_concurrent_atomic_AtomicLong=function(){function a(){}return a["VMSupportsCS8()Z"]=function(a){return!0},a}(),java_util_jar_JarFile=function(){function a(){}return a["getMetaInfEntryNames()[Ljava/lang/String;"]=function(a,b){var c=GetZipFile(a,b["java/util/zip/ZipFile/jzfile"].toNumber());if(c){if(!c.existsSync("/META-INF"))return null;for(var d=["/META-INF"],e=a.getBsCl(),f=[util.initString(e,"META-INF/")];d.length>0;){for(var g=d.pop(),h=c.readdirSync(g),i=0;i<h.length;i++){var j=g+"/"+h[i];c.statSync(j,!1).isDirectory()?(d.push(j),f.push(util.initString(e,j.slice(1)+"/"))):f.push(util.initString(e,j.slice(1)))}return util.newArrayFromData(a,e,"[Ljava/lang/String;",f)}}},a}(),java_util_logging_FileHandler=function(){function a(){}return a["isSetUID()Z"]=function(a){return!1},a}(),java_util_TimeZone=function(){function a(){}return a["getSystemTimeZoneID(Ljava/lang/String;)Ljava/lang/String;"]=function(a,b){var c=(new Date).getTimezoneOffset()/60;return a.getJVM().internString("GMT"+(c>0?"-":"+")+c)},a["getSystemGMTOffsetID()Ljava/lang/String;"]=function(a){return null},a}(),java_util_zip_Adler32=function(){function a(){}return a["update(II)I"]=function(a,b,c){return adler32(b,[255&c],1,0)},a["updateBytes(I[BII)I"]=function(a,b,c,d,e){return adler32(b,i82u8(c.array,d,e),e,0)},a["updateByteBuffer(IJII)I"]=function(a,b,c,d,e){var f=a.getJVM().getHeap(),g=BFSUtils.buffer2Arrayish(f.get_buffer(c.toNumber()+d,e));return adler32(b,g,g.length,0)},a}(),java_util_zip_CRC32=function(){function a(){}return a["update(II)I"]=function(a,b,c){return crc32(b,[255&c],1,0)},a["updateBytes(I[BII)I"]=function(a,b,c,d,e){return crc32(b,i82u8(c.array,d,e),e,0)},a["updateByteBuffer(IJII)I"]=function(a,b,c,d,e){var f=a.getJVM().getHeap(),g=BFSUtils.buffer2Arrayish(f.get_buffer(c.toNumber()+d,e));return crc32(b,g,g.length,0)},a}(),java_util_zip_Deflater=function(){function a(){}return a["initIDs()V"]=function(a){},a["init(IIZ)J"]=function(a,b,c,d){var e=8,f=8,g=new ZStreamCons,h=deflate.deflateInit2(g,b,f,d?-MAX_WBITS:MAX_WBITS,e,c);if(0==h){var i=OpenZStream(g);return Long.fromNumber(i)}var j=g.msg?g.msg:-2==h?"inflateInit2 returned Z_STREAM_ERROR":"unknown error initializing zlib library";a.throwNewException("Ljava/lang/InternalError;",j)},a["setDictionary(J[BII)V"]=function(a,b,c,d,e){a.throwNewException("Ljava/lang/UnsatisfiedLinkError;","Native method not implemented.")},a["deflateBytes(J[BIII)I"]=function(a,b,c,d,e,f,g){var h=GetZStream(a,c.toNumber());if(h){var i=b["java/util/zip/Deflater/buf"],j=b["java/util/zip/Deflater/off"],k=b["java/util/zip/Deflater/len"],l=i.array,m=d.array;if(h.input=i82u8(l,0,l.length),h.next_in=j,h.avail_in=k,h.output=i82u8(m,0,m.length),h.next_out=e,h.avail_out=f,b["java/util/zip/Deflater/setParams"]){var n=b["java/util/zip/Deflater/level"],o=b["java/util/zip/Deflater/level"],p=new ZStreamCons,q=deflate.deflateInit2(p,n,h.state.method,h.state.windowBits,h.state.memLevel,o);switch(ZStreams[c.toNumber()]=p,q){case 0:return b["java/util/zip/Deflater/setParams"]=0,j+=k-h.avail_in,b["java/util/zip/Deflater/off"]=j,b["java/util/zip/Deflater/len"]=h.avail_in,f-h.avail_out;case-5:return b["java/util/zip/Deflater/setParams"]=0,0;default:a.throwNewException("Ljava/lang/InternalError;",h.msg)}}else{var r=b["java/util/zip/Deflater/finish"],q=deflate.deflate(h,r?4:g);switch(q){case 1:b["java/util/zip/Deflater/finished"]=1;case 0:return j+=k-h.avail_in,b["java/util/zip/Deflater/off"]=j,b["java/util/zip/Deflater/len"]=h.avail_in,f-h.avail_out;case-5:return 0;default:a.throwNewException("Ljava/lang/InternalError;",h.msg)}}}},a["getAdler(J)I"]=function(a,b){var c=GetZStream(a,b.toNumber());return c?c.adler:void 0},a["reset(J)V"]=function(a,b){var c=GetZStream(a,b.toNumber());c&&0!==deflate.deflateReset(c)&&a.throwNewException("Ljava/lang/InternalError;",c.msg)},a["end(J)V"]=function(a,b){var c=GetZStream(a,b.toNumber());c&&(-2===deflate.deflateEnd(c)?a.throwNewException("Ljava/lang/InternalError;",c.msg):CloseZStream(b.toNumber()))},a}(),java_util_zip_Inflater=function(){function a(){}return a["initIDs()V"]=function(a){},a["init(Z)J"]=function(a,b){var c=new ZStreamCons,d=inflate.inflateInit2(c,b?-MAX_WBITS:MAX_WBITS);switch(d){case 0:var e=OpenZStream(c);return Long.fromNumber(e);default:var f=c.msg?c.msg:-2==d?"inflateInit2 returned Z_STREAM_ERROR":"unknown error initializing zlib library";a.throwNewException("Ljava/lang/InternalError;",f)}},a["setDictionary(J[BII)V"]=function(a,b,c,d,e){a.throwNewException("Ljava/lang/UnsatisfiedLinkError;","Native method not implemented.")},a["inflateBytes(J[BII)I"]=function(a,b,c,d,e,f){var g=GetZStream(a,c.toNumber());if(g){var h=b["java/util/zip/Inflater/buf"],i=b["java/util/zip/Inflater/off"],j=b["java/util/zip/Inflater/len"];if(0===j||0===f)return 0;var k=h.array,l=d.array;g.input=i82u8(k,0,k.length),g.next_in=i,g.avail_in=j,g.output=i82u8(l,0,l.length),g.next_out=e,g.avail_out=f;var m=inflate.inflate(g,2),n=f-g.avail_out;if(!isInt8Array(l))for(var o=g.output,p=0;n>p;p++){var q=o[p+e];q>127&&(q|=4294967168),l[p+e]=q}switch(m){case 1:b["java/util/zip/Inflater/finished"]=1;case 0:return i+=j-g.avail_in,b["java/util/zip/Inflater/off"]=i,b["java/util/zip/Inflater/len"]=g.avail_in,n;case 2:return b["java/util/zip/Inflater/needDict"]=1,i+=j-g.avail_in,b["java/util/zip/Inflater/off"]=i,b["java/util/zip/Inflater/len"]=g.avail_in,0;case-5:return 0;case-3:return void a.throwNewException("Ljava/util/zip/DataFormatException;",g.msg);default:return void a.throwNewException("Ljava/lang/InternalError;",g.msg)}}},a["getAdler(J)I"]=function(a,b){var c=GetZStream(a,b.toNumber());return c?c.adler:void 0},a["reset(J)V"]=function(a,b){var c=b.toNumber(),d=GetZStream(a,c);if(d){var e=new ZStreamCons;inflate.inflateInit2(e,d.state.wrap?MAX_WBITS:-MAX_WBITS);ZStreams[c]=e}},a["end(J)V"]=function(a,b){var c=GetZStream(a,b.toNumber());c&&(-2===inflate.inflateEnd(c)?a.throwNewException("Ljava/lang/InternalError;",c.msg):CloseZStream(b.toNumber()))},a}(),java_util_zip_ZipFile=function(){function a(){}return a["initIDs()V"]=function(a){},a["getEntry(J[BZ)J"]=function(a,b,c,d){var e=GetZipFile(a,b.toNumber());if(e){var f=new Buffer(c.array).toString("utf8");"/"!==f[0]&&(f="/"+f),f=path.resolve(f);try{return Long.fromNumber(OpenZipEntry(e.getCentralDirectoryEntry(f)))}catch(g){return Long.ZERO}}},a["freeEntry(JJ)V"]=function(a,b,c){CloseZipEntry(c.toNumber())},a["getNextEntry(JI)J"]=function(a,b,c){var d=GetZipFile(a,b.toNumber());if(d)try{return Long.fromNumber(OpenZipEntry(d.getCentralDirectoryEntryAt(c)))}catch(e){return Long.ZERO}},a["close(J)V"]=function(a,b){CloseZipFile(b.toNumber())},a["open(Ljava/lang/String;IJZ)J"]=function(a,b,c,d,e){for(var f=b.toString(),g=a.getBsCl().getClassPathItems(),h=0;h<g.length;h++){var i=g[h];if(i instanceof AbstractClasspathJar&&path.resolve(i.getPath())===path.resolve(f))return Long.fromNumber(OpenZipFile(i.getFS()))}a.setStatus(ThreadStatus.ASYNC_WAITING),fs.readFile(f,function(b,c){b?a.throwNewException("Ljava/io/IOException;",b.message):a.asyncReturn(Long.fromNumber(OpenZipFile(new BrowserFS.FileSystem.ZipFS(c,f))),null)})},a["getTotal(J)I"]=function(a,b){var c=GetZipFile(a,b.toNumber());return c?c.getNumberOfCentralDirectoryEntries():void 0},a["startsWithLOC(J)Z"]=function(a,b){return 1},a["read(JJJ[BII)I"]=function(a,b,c,d,e,f,g){var h=GetZipEntry(a,c.toNumber()),i=d.toNumber();if(h){if(0>=g)return 0;var j=h.getRawData();if(i>=j.length)return void a.throwNewException("Ljava/io/IOException;","End of zip file.");i+g>j.length&&(g=j.length-i);var k=e.array;if(CanUseCopyFastPath){var l=k,m=new Buffer(l.buffer);return j.copy(m,f+l.byteOffset,i,i+g)}for(var n=0;g>n;n++)k[f+n]=j.readInt8(i+n);return g}},a["getEntryTime(J)J"]=function(a,b){var c=GetZipEntry(a,b.toNumber());return c?Long.fromNumber(c.rawLastModFileTime()):void 0},a["getEntryCrc(J)J"]=function(a,b){var c=GetZipEntry(a,b.toNumber());return c?Long.fromNumber(c.crc32()):void 0},a["getEntryCSize(J)J"]=function(a,b){var c=GetZipEntry(a,b.toNumber());return c?Long.fromNumber(c.compressedSize()):void 0},a["getEntrySize(J)J"]=function(a,b){var c=GetZipEntry(a,b.toNumber());return c?Long.fromNumber(c.uncompressedSize()):void 0},a["getEntryMethod(J)I"]=function(a,b){var c=GetZipEntry(a,b.toNumber());return c?c.compressionMethod():void 0},a["getEntryFlag(J)I"]=function(a,b){var c=GetZipEntry(a,b.toNumber());return c?c.flag():void 0},a["getCommentBytes(J)[B"]=function(a,b){var c=GetZipFile(a,b.toNumber());if(c){var d=c.getEndOfCentralDirectory(),e=d.rawCdZipComment();return util.newArrayFromDataWithClass(a,a.getBsCl().getInitializedClass(a,"[B"),buff2i8(e))}},a["getEntryBytes(JI)[B"]=function(a,b,c){var d=GetZipEntry(a,b.toNumber());if(d)switch(c){case 2:return util.newArrayFromDataWithClass(a,a.getBsCl().getInitializedClass(a,"[B"),buff2i8(d.rawFileComment()));case 1:return util.newArrayFromDataWithClass(a,a.getBsCl().getInitializedClass(a,"[B"),buff2i8(d.extraField()));case 0:return util.newArrayFromDataWithClass(a,a.getBsCl().getInitializedClass(a,"[B"),buff2i8(d.rawFileName()));default:return null}},a["getZipMessage(J)Ljava/lang/String;"]=function(a,b){return util.initString(a.getBsCl(),"Something bad happened.")},a}();registerNatives({"java/util/concurrent/atomic/AtomicLong":java_util_concurrent_atomic_AtomicLong,"java/util/jar/JarFile":java_util_jar_JarFile,"java/util/logging/FileHandler":java_util_logging_FileHandler,"java/util/TimeZone":java_util_TimeZone,"java/util/zip/Adler32":java_util_zip_Adler32,"java/util/zip/CRC32":java_util_zip_CRC32,"java/util/zip/Deflater":java_util_zip_Deflater,"java/util/zip/Inflater":java_util_zip_Inflater,"java/util/zip/ZipFile":java_util_zip_ZipFile});
//# sourceMappingURL=java_util.js.map